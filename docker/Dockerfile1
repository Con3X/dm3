FROM --platform=linux/amd64 node:22-alpine as build
WORKDIR /build
COPY . .
# we need coreutils for proper ls command
RUN apk add --update coreutils python3 make g++ curl bash\
   && rm -rf /var/cache/apk/*
RUN yarn install
RUN yarn build

## Export libraries into archives
WORKDIR '/build/packages/lib'
# pack libraries into archives. they are copied to and used in the delivery service image.
# we ignore the billboard-api library because it is not properly connected to our monorepo
RUN mkdir /library-archives
RUN for lib in `ls -I billboard-api`; do cd $lib; yarn pack --filename /library-archives/$lib.tgz; cd ..;  done


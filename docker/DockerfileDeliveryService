FROM --platform=linux/amd64 node:18-alpine as build
WORKDIR /app

RUN apk add --update bash\
    && rm -rf /var/cache/apk/*

# copy the relevant package into the image
COPY ./packages/delivery-service/ /app/

# manually remove all references to libraries. we will replace them in the next step.
RUN sed -i '/.*dm3-org\/dm3-lib.*/d' ./package.json

# install libraries from local archives
COPY ./packages/lib/server-side.tgz /app
COPY ./packages/lib/crypto.tgz /app
COPY ./packages/lib/delivery.tgz /app
COPY ./packages/lib/messaging.tgz /app
COPY ./packages/lib/profile.tgz /app
COPY ./packages/lib/shared.tgz /app
COPY ./packages/lib/storage.tgz /app
RUN yarn add file:server-side.tgz file:crypto.tgz file:delivery.tgz file:messaging.tgz file:profile.tgz file:shared.tgz file:storage.tgz

RUN yarn install

ENTRYPOINT ["yarn", "start"]




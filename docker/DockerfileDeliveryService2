FROM --platform=linux/amd64 node:18-alpine as build
WORKDIR /app

# copy the whole repository to the container
COPY . .


# are g++, python and make really needed?
RUN apk add --update python3 make g++ curl bash\
   && rm -rf /var/cache/apk/*

RUN yarn install

# build libraries
WORKDIR /app/packages/lib
RUN yarn build

# pack libraries into archives
RUN for lib in `ls`; do cd $lib; yarn pack --filename ../$lib.tgz; cd ..;  done

# build delivery service
WORKDIR /app/packages/delivery-service
RUN yarn build
# pack delivery service into archive
RUN yarn pack --filename ../delivery-service.tgz

# start over with a new image
FROM node:18-alpine
WORKDIR /app/packages/delivery-service

# copy and extract the delivery service archive
COPY --from=build /app/packages/delivery-service/delivery-service.tgz /app
RUN tar -xvzf delivery-service.tgz
RUN rm delivery-service.tgz
RUN mv package/* .

# copy and add the libraries archives
COPY --from=build /app/packages/lib/*.tgz /app
RUN for lib in `ls *.tgz`; do yarn add file:$lib; done

# install dependencies
RUN yarn

